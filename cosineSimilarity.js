var TOLLERANCE = 3;

var test1 = [[0.8032379,9.154465,3.1979523],
            [0.76753235,9.632919,2.9837189],
            [1.5173492,10.739792,1.7483063],
            [0.08198547,7.238266,7.056534],
            [3.8881989,8.16423,1.098465],
            [-0.2584076,8.633163,3.3836212],
            [0.94844055,8.887863,1.919693],
            [15.011673,3.5486908,-3.0410004],
            [-19.944077,8.507004,11.155533],
            [20.338943,2.4418182,-0.9391327],
            [-20.774826,13.017807,7.430252],
            [13.143082,5.193527,3.7692413],
            [-15.323776,15.105392,0.032058716],
            [4.8736725,5.1697235,3.5502472],
            [-0.40837097,7.71434,-2.0650482],
            [5.921036,6.3123016,2.721878],
            [-1.774704,6.909775,-2.0079193],
            [0.34144592,6.348007,1.6673737],
            [7.0350494,3.8033905,-5.3571014],
            [-1.3790601,4.9799395,7.699753],
            [-1.4173675,5.3247046,7.776367],
            [-1.4556746,5.2863975,8.0445175],
            [-1.4556746,5.439626,8.580819],
            [-1.340753,5.5162406,8.810662],
            [-1.1492168,5.439626,8.580819],
            [-1.1492168,5.401319,8.274361],
            [-1.0342951,5.592855,7.8529816],
            [-1.1109096,5.631162,7.776367],
            [-1.4173675,5.5162406,7.73806],
            [-3.1028855,5.094861,7.6614456],
            [-1.6472107,6.167464,8.925584],
            [-1.0342951,7.1634517,9.11712],
            [-1.2258313,7.469909,6.435614],
            [-1.4939818,6.6271505,5.93762],
            [-1.1875241,6.090849,6.5505357],
            [-0.91937345,6.0142345,6.895301],
            [-1.1109096,5.9759274,8.197746],
            [-0.8810662,6.3206925,9.11712],
            [-0.4213795,6.7803793,8.465898],
            [-0.6895301,6.397307,6.9719152],
            [-0.2681506,6.6271505,6.895301],
            [-0.076614454,7.2783732,7.2783732],
            [0.5363012,7.393295,7.3549876],
            [3.6953888,6.7336273,1.4840851],
            [-7.182907,9.644821,-5.457077],
            [10.872208,4.229477,6.71138],
            [-14.811996,12.9440155,-6.6972504],
            [9.032181,5.3553925,5.5664215],
            [0.038307227,5.209783,5.056554],
            [0.9959879,5.746084,4.7884035],
            [0.91937345,7.929596,5.592855],
            [-0.076614454,7.3166804,6.4739213],
            [0.038307227,7.2783732,7.6614456],
            [-0.22984336,7.2783732,6.3206925],
            [-0.34476504,7.3166804,5.66947],
            [-0.7661445,7.8529816,5.439626],
            [-0.19153613,7.1634517,6.3589997],
            [-0.5363012,7.086837,7.393295],
            [-0.842759,7.469909,8.159439],
            [0.076614454,7.5082164,7.6231384],
            [0.076614454,7.086837,6.2823853],
            [-0.34476504,6.6654577,5.707777],
            [-1.2258313,6.6654577,5.0182467],
            [-1.1875241,7.1634517,5.2480903],
            [-0.7278373,7.5465236,6.090849],
            [-0.11492168,7.776367,7.1634517],
            [-0.7278373,7.6231384,6.742072],
            [-0.7661445,7.3166804,6.6654577],
            [-0.6895301,7.240066,6.4739213],
            [-0.91937345,7.3166804,6.205771],
            [-1.0342951,7.240066,6.3206925],
            [-0.7278373,7.3549876,6.7803793],
            [-0.5746084,7.431602,7.086837],
            [-0.34476504,7.699753,6.8186865],
            [-0.5746084,7.5848308,6.588843],
            [-0.7278373,7.3549876,6.205771],
            [-0.6895301,7.2783732,5.7843914],
            [-6.052231,8.873581,-3.519455],
            [-4.416916,7.764328,0.16059875],
            [19.781937,4.224716,3.702591],
            [-28.196823,8.397507,-3.8550873],
            [22.231339,2.7584076,8.403824],
            [-19.077621,12.556015,-8.149277],
            [-0.6512229,7.3549876,5.746084],
            [-0.7278373,7.776367,6.167464],
            [-0.2681506,7.8146744,6.0525417],
            [-0.22984336,7.8912888,5.93762],
            [-0.30645782,7.8529816,5.8226986],
            [-0.45968673,7.776367,5.899313],
            [-0.4213795,7.8529816,6.090849],
            [-0.5363012,7.73806,5.631162],
            [-0.45968673,7.6231384,4.9416323],
            [-0.38307226,8.082825,5.707777],
            [-0.5363012,7.967903,6.0142345],
            [-0.45968673,7.929596,6.244078],
            [-0.45968673,7.8529816,6.205771],
            [-0.61291564,7.6614456,5.8226986],
            [-0.6895301,7.699753,5.707777],
            [-0.5363012,7.73806,6.0142345],
            [-0.34476504,7.929596,6.090849],
            [-0.30645782,7.929596,5.93762],
            [-0.38307226,7.73806,5.899313],
            [-0.45968673,7.6614456,5.861006],
            [-0.45968673,7.73806,6.0525417],
            [-0.45968673,7.8146744,6.0142345],
            [-0.34476504,7.8912888,5.9759274],
            [-0.5363012,7.5082164,5.899313],
            [-0.34476504,7.8912888,5.8226986],
            [-0.38307226,7.73806,5.861006],
            [-0.49799395,7.776367,6.129156],
            [-0.4213795,7.73806,6.167464],
            [8.25856,7.204941,5.985367],
            [3.3359528,6.186142,-0.370224],
            [-10.294052,5.2458954,2.7885284],
            [-0.67259216,8.9092865,2.2267609],
            [2.3600006,10.575546,0.8747101],
            [0.8032379,9.461533,3.0194244],
            [-0.34476504,7.699753,6.205771],
            [-0.2681506,7.699753,6.0142345],
            [-0.5746084,7.6231384,5.861006],
            [-0.5746084,7.6614456,6.129156],
            [-0.49799395,7.699753,6.244078],
            [-0.4213795,7.699753,6.129156],
            [-0.49799395,7.6614456,6.3206925],
            [-0.6512229,7.5848308,6.2823853],
            [-0.49799395,7.6231384,6.205771],
            [-0.5363012,7.6231384,6.205771],
            [-0.5746084,7.5848308,6.167464],
            [-0.61291564,7.6231384,6.0525417],
            [-0.5363012,7.5848308,6.129156],
            [-0.5363012,7.5848308,6.2823853],
            [-0.5363012,7.5848308,6.3206925],
            [-0.5363012,7.5848308,6.205771],
            [-0.5746084,7.5465236,6.0525417],
            [-0.6512229,7.5465236,6.0525417],
            [-0.49799395,7.6231384,6.205771],
            [-0.45968673,7.6231384,6.2823853],
            [-0.61291564,7.5465236,6.167464]];

var test2 = [[0.8032379,9.154465,3.1979523],
              [-0.6512229,7.469909,6.205771],
              [8.364143,-2.641403,4.0013094],
              [-19.60911,-18.443134,-13.846866],
              [19.607914,5.306748,16.812683],
              [19.607914,12.648567,8.423999],
              [-4.697424,-4.8919525,1.234211],
              [12.1284275,-19.608511,13.883976],
              [10.816404,4.2221746,9.733028],
              [6.333262,6.6588736,3.940856],
              [2.0087352,5.269638,4.695628],
              [0.29867667,4.696825,7.502231],
              [0.9816227,3.9827545,8.867524],
              [1.2689269,4.2341456,8.579023],
              [0.90261406,4.2012253,8.680777],
              [0.76554596,4.1545386,8.994417],
              [1.1145009,4.3598413,8.560468],
              [-0.7613561,3.3554738,8.931569],
              [-0.6727707,3.3931823,8.893861],
              [-0.5243302,3.401562,9.523536],
              [-0.44711718,3.4913447,9.100361],
              [-0.036511578,3.5500026,9.2069025],
              [1.0444705,3.5296519,9.397242],
              [1.8207904,3.8774097,7.7470384],
              [1.5059528,3.1914709,8.911219],
              [13.6409645,7.1371155,18.39944],
              [11.304223,5.719149,10.484209],
              [-19.60911,-19.608511,-19.608511],
              [19.607914,-1.3880384,19.608511],
              [15.82687,-6.0010667,11.446678],
              [-19.60911,-19.608511,-10.845734],
              [19.607914,7.7973166,19.608511],
              [19.607914,-14.793174,4.370615],
              [-19.60911,-19.608511,10.897807],
              [19.607914,-15.378556,19.608511],
              [19.607914,-16.265608,-3.2758665],
              [-19.60911,-19.608511,8.958505],
              [19.607914,-1.4682442,9.664794],
              [19.607914,-19.337967,-1.043872],
              [-19.60911,-19.608511,19.608511],
              [8.364143,-2.641403,4.0013094],
              [-19.60911,-18.443134,-13.846866],
              [19.607914,5.306748,16.812683],
              [19.607914,12.648567,8.423999],
              [-4.697424,-4.8919525,1.234211],
              [12.1284275,-19.608511,13.883976],
              [10.816404,4.2221746,9.733028],
              [6.333262,6.6588736,3.940856],
              [2.0087352,5.269638,4.695628],
              [0.29867667,4.696825,7.502231],
              [0.9816227,3.9827545,8.867524],
              [1.2689269,4.2341456,8.579023],
              [0.90261406,4.2012253,8.680777],
              [0.76554596,4.1545386,8.994417],
              [1.1145009,4.3598413,8.560468],
              [-0.7613561,3.3554738,8.931569],
              [-0.6727707,3.3931823,8.893861],
              [-0.5243302,3.401562,9.523536],
              [-0.44711718,3.4913447,9.100361],
              [-0.036511578,3.5500026,9.2069025],
              [1.0444705,3.5296519,9.397242],
              [1.8207904,3.8774097,7.7470384],
              [1.5059528,3.1914709,8.911219],
              [13.6409645,7.1371155,18.39944],
              [11.304223,5.719149,10.484209],
              [-19.60911,-19.608511,-19.608511],
              [19.607914,-1.3880384,19.608511],
              [15.82687,-6.0010667,11.446678],
              [-19.60911,-19.608511,-10.845734],
              [19.607914,7.7973166,19.608511],
              [19.607914,-14.793174,4.370615],
              [-19.60911,-19.608511,10.897807],
              [19.607914,-15.378556,19.608511],
              [19.607914,-16.265608,-3.2758665],
              [-19.60911,-19.608511,8.958505],
              [19.607914,-1.4682442,9.664794],
              [19.607914,-19.337967,-1.043872],
              [-19.60911,-19.608511,19.608511],
              [6554596,4.1545386,8.994417],
              [1.1145009,4.3598413,8.560468],
              [-0.7613561,3.3554738,8.931569],
              [-0.6727707,3.3931823,8.893861],
              [-0.5243302,3.401562,9.523536],
              [-0.44711718,3.4913447,9.100361],
              [-0.036511578,3.5500026,9.2069025],
              [1.0444705,3.5296519,9.397242],
              [1.8207904,3.8774097,7.7470384],
              [1.5059528,3.1914709,8.911219],
              [13.6409645,7.1371155,18.39944],
              [11.304223,5.719149,10.484209],
              [-19.60911,-19.608511,-19.608511],
              [19.607914,-1.3880384,19.608511],
              [15.82687,-6.0010667,11.446678],
              [-19.60911,-19.608511,-10.845734],
              [19.607914,7.7973166,19.608511],
              [19.607914,-14.793174,4.370615],
              [-19.60911,-19.608511,10.897807],
              [19.607914,-15.378556,19.608511],
              [19.607914,-16.265608,-3.2758665],
              [-19.60911,-19.608511,8.958505],
              [19.607914,-1.4682442,9.664794],
              [19.607914,-19.337967,-1.043872],
              [-19.60911,-19.608511,19.608511],
              [19.607914,10.804434,19.608511],
              [15.916653,-19.608511,2.6797101],
              [-19.60911,-19.608511,13.220183],
              [19.607914,14.646529,19.608511],
              [19.186533,-19.608511,1.3156139],
              [-19.60911,-19.608511,19.608511],
              [19.607914,18.125303,15.400104],
              [-0.56323594,2.7814639,9.200318],
              [-0.62967503,2.8604724,9.322423],
              [-0.7906851,2.6114755,9.34038],
              [-0.5662287,2.5983074,9.610924],
              [-0.40940848,2.6282349,9.507974],
              [-0.45968673,2.5851393,9.130288],
              [-0.4213795,2.5246856,9.476251],
              [-0.7015011,2.416348,9.729437],
              [-0.95588505,2.429516,9.427768],
              [-0.7230489,2.3780408,9.632472],
              [-0.57999533,2.5145104,9.333197],
              [-0.6123171,2.6599581,9.190742],
              [-0.44592008,2.5025394,9.4062195],
              [-0.41718966,2.3588872,9.78989],
              [-0.37588966,2.1188686,9.589376],
              [-0.090381116,2.5306711,9.492412],
              [-0.33877954,2.034473,8.10557],
              [1.1372458,2.6581624,9.664794],
              [0.8643068,2.4426842,8.87351],
              [0.3669114,2.2457612,9.303269],
              [0.31783026,2.3762453,9.812037]];

var short1 = [[0,1,0],
              [0,5,0],
              [0,1,0]
              [30,-30, 0],
              [0,22,3],
              [34,0,0]];

var short2 = [[0,0,0],
              [0,0,1],
              [0,1,0],
              [0,5,0],
              [0,1,0],
              [30,-30, 0]];


// testing from the command line
var args = process.argv.slice(2);

args[0] = test1;
args[1] = test2;

if (args.length == 2) {
  console.log("Similarity Score: " + similarityScore(args[0], args[1]));
} else {
  console.log("Feed me some accelerometer arrays.");
}

// returns a similarity score given two sets of 3 dimensional signals
function similarityScore (a, b) {

  // convert all to magnitudes
  a = convertToMag(a);
  b = convertToMag(b);

  // allign to first local max

  aFirstMax = firstMax(a);
  bFirstMax = firstMax(b);

  if (aFirstMax < bFirstMax) {
    b = b.slice(bFirstMax - aFirstMax, b.length);
  }

  if (aFirstMax > bFirstMax) {
    a = a.slice(aFirstMax - aFirstMax, a.length);
  }

  // trim back to match the length
  if (a.length < b.length) {
    b = b.slice(0, a.length);
  }

  if (a.length > b.length) {
    a = a.slice(0, b.length);
  }

  return cosineSimilarity(a, b);
}

// returns the index of the first local max that exceeds TOLLERANCE
function firstMax(a) {

  // find first max
  ai = 1;
  for (ai = 1; ai < a.length; ai++) {
    if (a[ai] + TOLLERANCE < a[ai-1]) {
      return ai;
    }
  }

  return -1;
}

// given an array of vectors, returns an array of the magnitudes of each vector.
// result a[i] = input |a[i]|
function convertToMag(a) {
  return a.map(function (vec) { return magnitude(vec); });
}

//returns the cosine similarity
function cosineSimilarity(a, b) {
  return dotProduct(a, b) / (magnitude(a) * magnitude(b));
}


// returns the magnitude of the given vector
function magnitude(vec) {
  mag = 0;

  for(i = 0; i < vec.length; i++) {
    mag += vec[i] * vec[i];
  }
  return Math.sqrt(mag);
}

// returns the dot product of the two vectors
function dotProduct(a, b) {
  dotProd = 0;

  for (i = 0; i < a.length; i++) {
    dotProd += a[i] * b[i];
  }
  return dotProd;
}
